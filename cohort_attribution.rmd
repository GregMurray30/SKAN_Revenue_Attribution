---
title: "Untitled"
author: "Greg"
date: "5/30/2021"
output: html_document
---

```{r}
library(rstan)
library(shinystan)
library(lmtest)
library(data.table)
library(magrittr)
library(dplyr)
library(tidybayes)
options(mc.cores=4)
par(mar=c(2,2,2,2)) #set margins
```

```{r}
#Total number of installs in the postback (could be a mix of day a and day b installs)
K_c_skan = c(60, 50, 40)
K_skan = sum(K_c_skan)

#Priors derived from marginal probabilities in the SKAN send times
prior_mu_c_a_good = c(20, 30, 29)
prior_mu_c_a_okay = c(18, 34, 32)
prior_mu_c_a_bad = c(12, 38, 22)

num_cmps = 3
#Vector of actual install counts for each campaign to generate the total installs in the EA server (inst_c_a is not passed to model), Also used to calculate accuracy as they are the labels
inst_c_a = c(23, 31, 28)
#Number of organic installs
ORG_a = 110

I_ea_a = sum(inst_c_a)+ORG_a

```

```{r}

chrt_attr_mod1 = stan_model('/Users/greg.murray/OneDrive - Glu Mobile Inc/IDFA/attribution_models/cohort_attribution/cohort_attribution_v2.stan')
#chrt_attr_mod1 = stan_model('cohort_attribution_v2.stan')
fit_chrt_attr_goodprior = sampling(chrt_attr_mod1, list( I_ea_a=I_ea_a, K_c_skan = K_c_skan, prior_mu_c_a=prior_mu_c_a_good, num_cmps=num_cmps  ), chains=4, iter=10000, warmup=3000)
print(fit_chrt_attr_goodprior, pars=c("inst_c_a", "ORG_a", "inst_c_a_sum"))


```

```{r}
print(inst_c_a)
print(fit_chrt_attr_goodprior)
```

```{r}


dataset = data.frame(inst_c_a)
colnames(dataset) <- c('install_actuals')

fit_chrt_attr_goodprior %>% gather_draws(inst_c_a[N]) %>%
  left_join(
    dataset %>% 
      select(install_actuals) %>%
      mutate(N = 1:n())
  ) %>%
  rename(inst_c_a = .value) %>%
  ggplot(aes(x = install_actuals, y = inst_c_a)) + 
  geom_point(size = 0.1, alpha = 0.2) +
  geom_abline(data = data.frame(slope = 1, intercept = 0), 
              aes(intercept = intercept, slope = slope), 
              color = "red") +
  theme_minimal() + 
  ggtitle("Predictive Posterior")
```


